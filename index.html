<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>装備ステータス確率計算</title>
  <style>
    body { font-family: sans-serif; margin: 20px; }
    label { display: block; margin-top: 10px; }
    input[type="number"] { width: 60px; }
    .group { margin: 15px 0; padding: 10px; border: 1px solid #ccc; }
  </style>
</head>
<body>
  <h1>装備ステータス確率計算</h1>
  <p>
    装備は13種類中から5種類が付与され、そのうちターゲットとするのは A および C, D, E, F です。<br>
    <strong>ターゲット条件：</strong> A は「レベル ≥ X」、C～F は「レベル ≥ Y」
  </p>
  <form id="calcForm">
    <div class="group">
      <h3>閾値設定</h3>
      <label>
        タイプAの閾値（1～4）:
        <input type="number" id="thA" value="3" min="1" max="4">
      </label>
      <label>
        タイプC～Fの閾値（1～8）:
        <input type="number" id="thX" value="5" min="1" max="8">
      </label>
    </div>

    <div class="group">
      <h3>確率設定：タイプA（レベル1～4）[%]</h3>
      <label>レベル1: <input type="number" id="A1" value="12.43" step="0.1"></label>
      <label>レベル2: <input type="number" id="A2" value="46.21" step="0.1"></label>
      <label>レベル3: <input type="number" id="A3" value="38.57" step="0.1"></label>
      <label>レベル4: <input type="number" id="A4" value="2.79" step="0.1"></label>
    </div>

    <div class="group">
      <h3>確率設定：タイプC～F（レベル1～8）[%]</h3>
      <label>レベル1: <input type="number" id="X1" value="7.39" step="0.1"></label>
      <label>レベル2: <input type="number" id="X2" value="6.90" step="0.1"></label>
      <label>レベル3: <input type="number" id="X3" value="20.72" step="0.1"></label>
      <label>レベル4: <input type="number" id="X4" value="24.90" step="0.1"></label>
      <label>レベル5: <input type="number" id="X5" value="18.23" step="0.1"></label>
      <label>レベル6: <input type="number" id="X6" value="13.60" step="0.1"></label>
      <label>レベル7: <input type="number" id="X7" value="5.34" step="0.1"></label>
      <label>レベル8: <input type="number" id="X8" value="2.93" step="0.1"></label>
    </div>

    <button type="button" onclick="calculate()">計算する</button>
  </form>

  <h2>結果</h2>
  <div id="result"></div>

  <script>
    // 組み合わせを計算する関数（nCk）
    function combination(n, k) {
      let num = 1, den = 1;
      for (let i = 1; i <= k; i++) {
        num *= (n - i + 1);
        den *= i;
      }
      return num / den;
    }

    // 指定したグループの確率分布から、閾値以上となる確率を求める
    // probs: 配列（例： [12.43,46.21,38.57,2.79]） ※合計は100になる前提
    // th: 閾値（例えば、タイプAなら3、タイプXなら5）
    function successProbability(probs, th) {
      let sum = 0;
      // 配列のインデックスは0～（レベル1～）
      for (let i = th - 1; i < probs.length; i++) {
        sum += parseFloat(probs[i]);
      }
      return sum / 100; // パーセンテージ→確率
    }

    function calculate() {
      // 閾値の取得
      let thA = parseInt(document.getElementById("thA").value);  // タイプA用
      let thX = parseInt(document.getElementById("thX").value);  // タイプC～F用

      // タイプAの確率（レベル1～4）
      let probsA = [
        document.getElementById("A1").value,
        document.getElementById("A2").value,
        document.getElementById("A3").value,
        document.getElementById("A4").value
      ];
      // タイプC～Fの確率（レベル1～8）
      let probsX = [
        document.getElementById("X1").value,
        document.getElementById("X2").value,
        document.getElementById("X3").value,
        document.getElementById("X4").value,
        document.getElementById("X5").value,
        document.getElementById("X6").value,
        document.getElementById("X7").value,
        document.getElementById("X8").value
      ];

      // 各成功確率の算出
      let pA = successProbability(probsA, thA);  // タイプAが閾値以上となる確率
      let pX = successProbability(probsX, thX);  // タイプC～Fが閾値以上となる確率

      // 装備は13種類中から5種類を重複なく付与
      // ターゲットとなるステータスは S = {A, C, D, E, F} の5種類
      // 装備内に m 個のターゲットステータスが現れる確率は
      // P(m) = (C(5, m) * C(8, 5-m)) / C(13, 5)
      let totalComb = combination(13, 5);
      let p_m = [];  // m=0,...,5
      for (let m = 0; m <= 5; m++) {
        p_m[m] = (combination(5, m) * combination(8, 5 - m)) / totalComb;
      }
      // ここでは、4個以上の成功が条件なので、m<4では絶対達成できない
      // ※ m=4 の場合、4 target が付与され、その4個すべてが「成功」している必要がある
      //  m=5 の場合は、5 target 中、成功数が4以上でOK

      let p_success = 0; // 全体の確率

      // ケース m = 4
      if (p_m[4] > 0) {
        // 装備内に4個のターゲットが現れた場合、
        // その内訳は S のうち A が含まれる確率は 4/5（＝1/5の場合は Aが抜ける）
        // ・Aが含まれる場合: 成功確率 = pA * (pX)^3
        // ・Aが含まれない場合: 成功確率 = (pX)^4
        let p_m4 = (4/5) * (pA * Math.pow(pX, 3)) + (1/5) * (Math.pow(pX, 4));
        p_success += p_m[4] * p_m4;
      }

      // ケース m = 5
      if (p_m[5] > 0) {
        // 装備内に5個のターゲットが現れた場合、組み合わせは必ず A, C, D, E, F
        // 成功数が4以上の場合の確率は、以下の2パターン：
        // (1) 全5成功: pA * (pX)^4
        // (2) ちょうど4成功:
        //      ・Aが失敗して残り4成功: (1-pA) * (pX)^4
        //      ・Aは成功し、C～Fのうち1つ失敗: 4 * pA * (pX)^3 * (1-pX)
        let p_all5 = pA * Math.pow(pX, 4);
        let p_exactly4 = (1 - pA) * Math.pow(pX, 4) + 4 * pA * Math.pow(pX, 3) * (1 - pX);
        let p_m5 = p_all5 + p_exactly4;
        p_success += p_m[5] * p_m5;
      }

      // 結果表示（パーセンテージ表示）
      let resultArea = document.getElementById("result");
      resultArea.innerHTML = "<p>1装備あたり、求めるステータスが4個以上付与される確率：<strong>" +
        (p_success * 100).toFixed(4) + "%</strong></p>";
    }
  </script>
</body>
</html>
