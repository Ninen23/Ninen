
<!DOCTYPE html>
<html>
<head>
    <title>VBAコード表示</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/default.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
    <script>hljs.initHighlightingOnLoad();</script>
</head>
<body>
    <pre><code class="vb">
Sub レポート()

    ' 変数の宣言
    Dim 活動実績ファイル名 As String
    Dim 要請シート名 As String
    Dim 解析シート名 As String
    Dim 支援シート名 As String
    Dim レポート開始日 As Date
    Dim レポート終了日 As Date
    Dim youseisheet As Worksheet
    Dim kaisekisheet As Worksheet
    Dim shiensheet As Worksheet
    Dim 管理番号Dic As Object
    Dim i As Long, j As Long
    Dim lastRow As Long, lastRow2 As Long, lastRow3 As Long
    Dim wb As Workbook
    Dim filePath As String
    Dim filename As String
    Dim filteredRange As Range, cell As Range
    Dim 解析人数 As Long, 解析日数 As Long
    Dim 解析 As Long, 支援依頼 As Long, 鑑定嘱託 As Long, 上位局依頼 As Long
    Dim 総警務 As Long, 刑事組対 As Long, 生安 As Long, 交通 As Long, 警備公安外事 As Long, 他官庁 As Long, その他 As Long

    ' エラー処理の開始
    On Error GoTo ErrorHandler

    ' 初期設定情報を読み込む
    活動実績ファイル名 = Range("G7").Value
    要請シート名 = Range("G8").Value
    解析シート名 = Range("G9").Value
    支援シート名 = Range("G10").Value
    レポート開始日 = Range("G14").Value
    レポート終了日 = Range("I14").Value

    ' 活動実績ファイルを開いているかチェック
    filePath = ThisWorkbook.Path & "\" & 活動実績ファイル名
    filename = Dir(filePath)

    If IsWorkbookOpen(filename) Then
        MsgBox 活動実績ファイル名 & "を閉じてから再度実行してください。"
        Exit Sub
    Else
        Set wb = Workbooks.Open(filePath)
    End If

    ' シート名設定
    Set youseisheet = wb.Worksheets(要請シート名)
    Set kaisekisheet = wb.Worksheets(解析シート名)
    Set shiensheet = wb.Worksheets(支援シート名)

    ' 管理番号、集計期間フラグ設定
    lastRow = youseisheet.UsedRange.Rows.Count
    Set 管理番号Dic = CreateObject("Scripting.Dictionary")

    For i = 1 To lastRow
        管理番号Dic(youseisheet.Cells(i, 2).Value) = Array(0, 0)
    Next i

    ' 管理番号をもとに解析シートから集計期間に含まれるもののフラグを付ける
    lastRow2 = kaisekisheet.UsedRange.Rows.Count
    For j = 2 To lastRow2
        If IsDate(kaisekisheet.Cells(j, 6)) Then
            Dim 管理番号 As Variant
            管理番号 = kaisekisheet.Cells(j, 2).Value
            If 管理番号Dic.Exists(管理番号) Then
                If kaisekisheet.Cells(j, 8) >= レポート開始日 And kaisekisheet.Cells(j, 6) <= レポート終了日 Then
                    管理番号Dic(管理番号)(0) = 管理番号Dic(管理番号)(0) + 1
                End If
            End If
        End If
    Next j

    ' 管理番号をもとに支援シートから集計期間に含まれるもののフラグを付ける
    lastRow3 = shiensheet.UsedRange.Rows.Count
    For j = 2 To lastRow3
        If IsDate(shiensheet.Cells(j, 10)) Then
            Dim 管理番号 As Variant
            管理番号 = shiensheet.Cells(j, 2).Value
            If 管理番号Dic.Exists(管理番号) Then
                If shiensheet.Cells(j, 10) >= レポート開始日 And shiensheet.Cells(j, 10) <= レポート終了日 Then
                    管理番号Dic(管理番号)(1) = 管理番号Dic(管理番号)(1) + 1
                End If
            End If
        End If
    Next j

    ' 解析シートからレポート情報を抽出
    With kaisekisheet.Cells
        .AutoFilter Field:=8, Criteria1:="<=" & レポート終了日, Criteria2:=">=" & レポート開始日

        ' 解析場所別の件数集計
        ThisWorkbook.Sheets("レポート").Range("F13") = WorksheetFunction.Subtotal(3, .Columns("F")) - 1
        .AutoFilter Field:=10, Criteria1:="<>解析室"
        ThisWorkbook.Sheets("レポート").Range("F14") = WorksheetFunction.Subtotal(3, .Columns("F")) - 1

        ' 解析場所のフィルターを解除
        .AutoFilter

        ' 解析人数の集計
        解析人数 = WorksheetFunction.Subtotal(3, .Columns("BC")) - 1
        解析人数 = 解析人数 + WorksheetFunction.Subtotal(3, .Columns("BD")) - 1
        解析人数 = 解析人数 + WorksheetFunction.Subtotal(3, .Columns("BE")) - 1
        解析人数 = 解析人数 + WorksheetFunction.Subtotal(3, .Columns("BF")) - 1
        解析人数 = 解析人数 + WorksheetFunction.Subtotal(3, .Columns("BG")) - 1
        解析人数 = 解析人数 + WorksheetFunction.Subtotal(3, .Columns("BH")) - 1

        ' 解析期間の集計
        解析日数 = 0
        Set filteredRange = .Range("BI2:BI" & lastRow2).SpecialCells(xlCellTypeVisible)
        For Each cell In filteredRange
            If cell.Value2 <> "" And cell.Offset(0, 1).Value2 <> "" And cell.Offset(0, 1).Value2 >= cell.Value2 Then
                解析日数 = 解析日数 + cell.Offset(0, 1).Value2 - cell.Value2 + 1
            End If
        Next cell

        ' 解析対象物の集計
        .AutoFilter Field:=11, Criteria1:="原本", Operator:=xlOr, Criteria2:="副本"
        ThisWorkbook.Sheets("レポート").Range("C12") = WorksheetFunction.Subtotal(3, .Columns("L")) - 1
        .AutoFilter Field:=12, Criteria1:="携帯電話"
        ThisWorkbook.Sheets("レポート").Range("C13") = WorksheetFunction.Subtotal(3, .Columns("L")) - 1
        .AutoFilter Field:=12, Criteria1:="タブレット"
        ThisWorkbook.Sheets("レポート").Range("C14") = WorksheetFunction.Subtotal(3, .Columns("L")) - 1
        .AutoFilter Field:=12, Criteria1:="記録媒体"
        ThisWorkbook.Sheets("レポート").Range("C15") = WorksheetFunction.Subtotal(3, .Columns("L")) - 1
        .AutoFilter Field:=12, Criteria1:="カーナビ・IVI"
        ThisWorkbook.Sheets("レポート").Range("C16") = WorksheetFunction.Subtotal(3, .Columns("L")) - 1
        .AutoFilter Field:=12, Criteria1:="その他"
        ThisWorkbook.Sheets("レポート").Range("C17") = WorksheetFunction.Subtotal(3, .Columns("L")) - 1

        ' 証拠物件フィルタ解除
        .AutoFilter 12

        ' 不正プログラム解析
        .AutoFilter Field:=35, Criteria1:="<>", Operator:=xlAnd, Criteria2:="<>0"
        ThisWorkbook.Sheets("レポート").Range("F18") = WorksheetFunction.Subtotal(3, .Columns("AI")) - 1
        .AutoFilter 35
    End With

    ' 支援シートからレポート情報を抽出
    With shiensheet.Cells
        ' レポート期間で絞る
        .AutoFilter Field:=7, Criteria1:="<=" & レポート終了日, Criteria2:=">=" & レポート開始日

        ' 支援人数別の集計
        解析人数 = 解析人数 + WorksheetFunction.Subtotal(3, .Columns("K")) - 1
        解析人数 = 解析人数 + WorksheetFunction.Subtotal(3, .Columns("L")) - 1
        解析人数 = 解析人数 + WorksheetFunction.Subtotal(3, .Columns("M")) - 1
        解析人数 = 解析人数 + WorksheetFunction.Subtotal(3, .Columns("N")) - 1

        ' 支援人数のフィルターを解除
        .AutoFilter

        ' 支援期間の集計
        For i = 2 To lastRow3
            If shiensheet.Cells(i, 7).Value <> "" And shiensheet.Cells(i, 6).Value <> "" Then
                解析日数 = 解析日数 + shiensheet.Cells(i, 7).Value2 - shiensheet.Cells(i, 6).Value2 + 1
            End If
        Next i
    End With

    ' 要請シートからレポート情報を抽出
    With youseisheet.Cells
        ' 解析要請数をカウント
        解析 = 0
        支援依頼 = 0
        鑑定嘱託 = 0
        上位局依頼 = 0
        総警務 = 0
        刑事組対 = 0
        生安 = 0
        交通 = 0
        警備公安外事 = 0
        他官庁 = 0
        その他 = 0

        For i = 2 To lastRow - 1
            ' 解析件数からカウント（解析、鑑定嘱託）
            If 管理番号Dic.Exists(.Cells(i, 2).Value) Then
                If 管理番号Dic(.Cells(i, 2).Value)(0) <> 0 Then
                    Select Case .Cells(i, 4)
                        Case "解析"
                            解析 = 解析 + 1
                        Case "支援依頼"
                            支援依頼 = 支援依頼 + 1
                        Case "鑑定嘱託"
                            鑑定嘱託 = 鑑定嘱託 + 1
                    End Select
                    ' 要請部門の集計
                    Select Case .Cells(i, 5)
                        Case "総警務"
                            総警務 = 総警務 + 1
                        Case "刑事組対"
                            刑事組対 = 刑事組対 + 1
                        Case "生安（地域）"
                            生安 = 生安 + 1
                        Case "交通"
                            交通 = 交通 + 1
                        Case "警備公安外事"
                            警備公安外事 = 警備公安外事 + 1
                        Case "他官庁"
                            他官庁 = 他官庁 + 1
                        Case Else
                            その他 = その他 + 1
                    End Select

                    ' 上位局への依頼件数をカウント（解析のみでカウント）
                    If .Cells(i, 15) = True Then
                        上位局依頼 = 上位局依頼 + 1
                    End If
                End If

                ' 支援数からカウント（支援依頼を想定）
                If 管理番号Dic(.Cells(i, 2).Value)(1) <> 0 Then
                    Select Case .Cells(i, 4)
                        Case "解析"
                            解析 = 解析 + 1
                        Case "支援依頼"
                            支援依頼 = 支援依頼 + 1
                        Case "鑑定嘱託"
                            鑑定嘱託 = 鑑定嘱託 + 1
                    End Select

                    ' 支援の要請部門を集計（数は解析と合算とする）
                    Select Case .Cells(i, 5)
                        Case "総警務"
                            総警務 = 総警務 + 1
                        Case "刑事組対"
                            刑事組対 = 刑事組対 + 1
                        Case "生安（地域）"
                            生安 = 生安 + 1
                        Case "交通"
                            交通 = 交通 + 1
                        Case "警備公安外事"
                            警備公安外事 = 警備公安外事 + 1
                        Case "他官庁"
                            他官庁 = 他官庁 + 1
                        Case Else
                            その他 = その他 + 1
                    End Select
                End If
            End If
        Next i

        ' 抽出した情報をセルに書き込み
        ThisWorkbook.Sheets("レポート").Range("G3") = レポート開始日 & "～" & レポート終了日
        ThisWorkbook.Sheets("レポート").Range("F7") = 解析
        ThisWorkbook.Sheets("レポート").Range("F8") = 支援依頼
        ThisWorkbook.Sheets("レポート").Range("F9") = 鑑定嘱託
        ThisWorkbook.Sheets("レポート").Range("C21") = 上位局依頼
        ThisWorkbook.Sheets("レポート").Range("I7") = 刑事組対
        ThisWorkbook.Sheets("レポート").Range("I8") = 生安
        ThisWorkbook.Sheets("レポート").Range("I9") = 交通
        ThisWorkbook.Sheets("レポート").Range("I10") = 総警務
        ThisWorkbook.Sheets("レポート").Range("I11") = 警備公安外事
        ThisWorkbook.Sheets("レポート").Range("I12") = 他官庁
        ThisWorkbook.Sheets("レポート").Range("I13") = その他
        ThisWorkbook.Sheets("レポート").Range("C8") = 解析人数
        ThisWorkbook.Sheets("レポート").Range("C7") = 解析日数
    End With

    ' 活動実績ファイルを閉じる
    wb.Close SaveChanges:=False

    ' メモリ解放
    Set 管理番号Dic = Nothing
    Set youseisheet = Nothing
    Set kaisekisheet = Nothing
    Set shiensheet = Nothing

    MsgBox "レポートの作成が完了しました。"

    Exit Sub

ErrorHandler:
    MsgBox "エラーが発生しました: " & Err.Description
    If Not wb Is Nothing Then wb.Close SaveChanges:=False
    Set 管理番号Dic = Nothing
    Set youseisheet = Nothing
    Set kaisekisheet = Nothing
    Set shiensheet = Nothing

End Sub

' ワークブックが開いているかどうかを確認する関数
Function IsWorkbookOpen(ByVal name As String) As Boolean
    Dim wb As Workbook
    On Error Resume Next
    Set wb = Workbooks(name)
    On Error GoTo 0
    IsWorkbookOpen = Not wb Is Nothing
End Function

                              </code></pre>
</body>
</html>
